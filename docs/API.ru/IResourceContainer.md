

# Модуль "ResourceContainer"
Контейнер ресурсов позволяет хранить ресурсы и обмениваться ими между контейнерами. Контейнер ресурсов имеет следующие параметры:
  - **volume** - объём контейнера - максимальный объем ресурсов, который может быть загружен в контейнер; измеряется в кубических метрах;
  - **transport_rate** - скорость транспортировки ресурса - определяет массу ресурса, которую контейнер может перекачать в другой контейнер за единицу времени; измеряется в кг/сек.
 

# Интерфейс IResourceContainer
```protobuf
message IResourceContainer {

  enum Status {
    SUCCESS               = 0;
    INTERNAL_ERROR        = 1;
    PORT_ALREADY_OPEN     = 2;
    PORT_DOESNT_EXIST     = 3;
    PORT_IS_NOT_OPENED    = 4;
    PORT_HAS_BEEN_CLOSED  = 5;
    INVALID_ACCESS_KEY    = 6;
    INVALID_RESOURCE_TYPE = 7;
    PORT_TOO_FAR          = 8;
    TRANSFER_IN_PROGRESS  = 9;
    NOT_ENOUGH_RESOURCES  = 10;
  }
  
  message Content {
    uint32 volume = 1;
    double used   = 2;
    repeated ResourceItem resources = 3;
  }

  message Transfer {
    uint32 port_id        = 1;
    uint32 access_key     = 2;
    ResourceItem resource = 3;
  }
  
  oneof choice {
    // Requests and command from Client
    bool           content_req       = 1;
    uint32         open_port         = 2;
    bool           close_port        = 3;
    Transfer       transfer          = 4;
    
    Content        content            = 21;
    uint32         port_opened        = 22;
    Status         open_port_failed   = 23;
    Status         close_port_status  = 24;
    Status         transfer_status    = 25;
    ResourceItem   transfer_report    = 26;
    Status         transfer_finished  = 27;
  }
}
```

## Как получить содержимое контейнера?
Чтобы получить содержимое контейнера необходимо отправить команду **content_req**. Команда имеет тип bool, однако её значение игнорируется. В ответ на команду поступит сообщение **content**, которое имеет тип **Content**:
```protobuf
message Content {
  uint32 volume = 1;
  double used   = 2;
  repeated ResourceItem resources = 3;
}
```
Сообщение содержит в себе следующие сведения:
  - **volume** - объём контейнера;
  - **used** - использованный объём (общий объём всех ресурсов в контейнере);
  - **resources** - перечисление всех ресурсов в контейнере.

## Как перенести ресурсы из одного контейнера в другой?
Процедура следующая:
1. принимающий контейнер открывает порт для приёма ресурсов от любого источника; порт описывается двумя параметрами:
	* **port_id** - уникальный идентификатор порта;
	* **access_key** - ключ доступа к порту.	
2. передающий контейнер, зная *port_id* и *access_key*отправляет запрос на передачу требуемого объёма ресурса определённого типа.

Передача ресурса происходит не мгновенно, а постепенно, в зависимости от параметра **transfer_rate** передающего контейнера. На протяжении всего процесса передачи дистанция между контейнерами не должна превышать 200 метров. Если указанное расстояние было превышено, то передача ресурса прекращается.

Один контейнер может передавать ресурсы только в один порт, а так же иметь только один открытый порт для приёма ресурсов. Однако один порт может принимать ресурсы от неограниченного числа контейнеров.

## Как открыть порт для приёма ресурсов?
Чтобы открыть порт, необходимо отправить команду **open_port**. Значением команды необходимо указать произвольный ключ доступа, или **AccessKey**.

В случае успеха, контейнер ответит сообщением **port_opened**, значением которого является номер порта *port_id*. Этот номер порта в сочетании с **AccessKey** может быть использован другими контейнерами для передачи ресурса на этот порт.

В случае неудачи контейнер отправит сообщение **open_port_failed** с одной из следующих причин:
  * **PORT_ALREADY_OPEN** - на данном контейнере уже есть открытый порт.

## Как отправить запрос на передачу ресурса?
Для этого нужно отправить сообщение **transfer**, которое имеет следующий формат:
```protobuf
message Transfer {
  uint32 port_id        = 1;
  uint32 access_key     = 2;
  ResourceItem resource = 3;
}
```
, где:
  * **port_id** - идентификатор порта, на который требуется передавать ресурс;
  * **access_key** - ключ для доступа к порту;
  * **resource** - тип и объём ресурса, который требуется передать.

В ответ будет отправлено сообщение **transfer_status** с одним из следующих возможных значений:
  * **SUCCESS** - процедура передачи запущена;
  * **PORT_IS_NOT_OPENED** - указанный порт не открыт;
  * **INVALID_ACCESS_KEY** - неверный ключ доступа к порту;
  * **TRANSFER_IN_PROGRESS** - уже есть активная процедура передачи ресурса.

## Наблюдение за процессом передачи ресурсов
После успешного запуска процедуры передачи, от контейнера начнут поступать сообщения **transfer_report** - извещения о переданных ресурсах. Извещения имеют тип **ResourceItem** и сообщают о том, какое количество ресурса было передано после отправки предыдущего извещения.

Когда передача ресурса завершена или прервана, модуль отправит сообщение **transfer_finished** с одним из следующих возможных значений:
  * **SUCCESS** - передача ресурсов успешно завершена;
  * **PORT_HAS_BEEN_CLOSED** - передача прервана, т.к. принимающий порт был закрыт;
  * **PORT_TOO_FAR** - передача прервана, т.к. порт слишком далеко.

## Как закрыть порт приёма?
Чтобы закрыть порт для приёма ресурсов, необходимо отправить команду **close_port**. В ответ на команду поступит подтверждение **port_closed** с одним из следующих значений:
  * **SUCCESS** - порт был закрыт;
  * **PORT_IS_NOT_OPENED** - порт не был открыт ранее.
