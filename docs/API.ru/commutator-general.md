# Что такое коммутатор?
**Коммутатор** - это устройство для создания **туннелей** или **виртуальных каналов** связи к устройствам, подключенным к коммутатору.
Коммутатор имеет **слоты** - точки для подключения других устройств. Устройством может выступать модуль, корабль или другой коммутатор. Во внутренней памяти коммутатора есть **таблица коммутации**, которая выглядит, например, так:

| Номер туннеля | Номер слота |
|---------------|-------------|
|  4            |  5          |
|  12           |  5          |
|  21           |  3          |

В данном случае её можно трактовать так:
1. сообщение, поступившее по туннелю #4 необходимо перенаправить устройство, подключённому к слоту #5
2. сообщение, поступившее по туннелю #12 необходимо перенаправить устройство, подключённому к слоту #5
3. сообщение, поступившее по туннелю #21 необходимо перенаправить устройство, подключённому к слоту #3

По сути, **туннель** - это правило в таблице коммутации. Как видно в данном примере, к устройству, подключенному к слоту #5 идёт сразу 2 туннеля: туннель #4 и туннель #12. Такая ситуация вполне допустима. Однако ситуация, когда один туннель подключен к нескольким устройствам **недопустима**.

Интерфейс коммутатора позволяет:
  - изучить список модулей, подключенных к коммутатору;
  - открывать/закрывать туннели (т.е. добавлять/удалять записи в таблицу коммутации);
  - туннелировать сообщения устройствам, подключенным к коммутатору.

## Что такое корневой коммутатор?
Когда игрок подключается к серверу, он получает доступ к **корневому коммутатору**. К этому коммутатору подключены все корабли, которыми игрок может управлять. Каждый корабль имеет в своём составе коммутатор, к которому подключены все модули. Таким образом, в самом простом случае имеем двухуровневую иерархию. Однако в реальности, она может быть глубже, например так:
![commutators example](https://i.ibb.co/2FrstsP/Commutators.png)

## Как коммутатор туннелирует сообщения?
Коммутатор хранит в своей внутренней памяти **таблицу коммутации**, где каждому номеру туннеля сопоставляется номер слота к устройству, к которому открыт данный туннель.

Если на коммутатор поступает сообщение **Message**, в которое упаковано **другое сообщение Message**, то коммутатор выполняет следующие действия:
  1. смотрит на поле **nTunnelId** поступившего сообщения;
  2. находит в таблице коммутации запись, с таким же номером nTunnelId;
  3. из записи получает номер слота **nSlotId** устройства, к которому был открыт данный туннель;
  4. **изымает** из полученного сообщения **Message** вложенное сообщение Message и **передаёт** его устройству, подключенному к слоту **nSlotId** (т.е. выполняет деинкапсуляцию).

Как было показано выше, вполне допустима ситуация, что к одному коммутатору подключен другой коммутатор. Поэтому если сообщению необходимо пройти через цепочку коммутаторов, оно **несколько раз** упаковывается в сообщение **Message**, и на каждом уровне указывается свой номер туннеля. Пример такого туннелирования:
![deencapsulation-example](https://i.ibb.co/XysZvvy/deencapsulation-example.png)
